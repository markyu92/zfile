import{b as c,g as b,x as _,a3 as _e,Y as ve,_ as ge,r as y,o as be,c as W,f as o,$ as j,e as I,w as s,k as l,a0 as f,F as $,G as N,y as P,l as Z,a2 as M,a1 as Se,aj as we}from"./index-008199ed.js";/* empty css                */import{E as ye}from"./dialog-9877e468.js";import"./overlay-64b24548.js";/* empty css                  *//* empty css                     *//* empty css                 */import"./tooltip-4ed993c7.js";/* empty css               *//* empty css                  */import{E as ke}from"./switch-6e3117dc.js";/* empty css                *//* empty css            *//* empty css                       *//* empty css                     */import{E as Le,d as xe}from"./button-30635c71.js";import{E as Pe,a as Ve}from"./input-73d413ba.js";import{_ as he}from"./Cancel-b93a9a48.js";import{c as Ee,s as ze,b as Ce}from"./admin-user-8224dae0.js";import{l as Ue}from"./admin-storage-185041e5.js";import{f as Ie,E as A,b as $e,e as De,t as Re}from"./request-7014ab81.js";import{g as Y}from"./base-00eb0fe9.js";import{b as J}from"./route-block-83d24a4e.js";import{_ as Fe}from"./_plugin-vue_export-helper-c27b6911.js";import{r as K}from"./QuestionMarkCircleIcon-492baaf8.js";import{r as Q}from"./CheckBadgeIcon-af1628c6.js";import{E as Be,a as Ne}from"./index-91840f01.js";import{E as Me}from"./index-dc7d0be4.js";import{E as Te}from"./index-60380bfa.js";import{E as qe}from"./index-751f7128.js";import{v as Oe}from"./directive-20abcd4b.js";import"./index-8286893b.js";import"./vnode-5e2fd68e.js";import"./index-4ea0a277.js";import"./scroll-374ad3fb.js";import"./refs-9142934b.js";import"./validator-38288ad7.js";import"./_initCloneObject-ffec0ace.js";import"./admin-form-header-819a5389.js";import"./arrow-left-6c74187b.js";import"./index-0da14aee.js";import"./index-293710b7.js";import"./debounce-3f0c1a7c.js";import"./dropdown-40114633.js";function Ge(h,m){return c(),b("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[_("path",{"fill-rule":"evenodd",d:"M11.078 2.25c-.917 0-1.699.663-1.85 1.567L9.05 4.889c-.02.12-.115.26-.297.348a7.493 7.493 0 0 0-.986.57c-.166.115-.334.126-.45.083L6.3 5.508a1.875 1.875 0 0 0-2.282.819l-.922 1.597a1.875 1.875 0 0 0 .432 2.385l.84.692c.095.078.17.229.154.43a7.598 7.598 0 0 0 0 1.139c.015.2-.059.352-.153.43l-.841.692a1.875 1.875 0 0 0-.432 2.385l.922 1.597a1.875 1.875 0 0 0 2.282.818l1.019-.382c.115-.043.283-.031.45.082.312.214.641.405.985.57.182.088.277.228.297.35l.178 1.071c.151.904.933 1.567 1.85 1.567h1.844c.916 0 1.699-.663 1.85-1.567l.178-1.072c.02-.12.114-.26.297-.349.344-.165.673-.356.985-.57.167-.114.335-.125.45-.082l1.02.382a1.875 1.875 0 0 0 2.28-.819l.923-1.597a1.875 1.875 0 0 0-.432-2.385l-.84-.692c-.095-.078-.17-.229-.154-.43a7.614 7.614 0 0 0 0-1.139c-.016-.2.059-.352.153-.43l.84-.692c.708-.582.891-1.59.433-2.385l-.922-1.597a1.875 1.875 0 0 0-2.282-.818l-1.02.382c-.114.043-.282.031-.449-.083a7.49 7.49 0 0 0-.985-.57c-.183-.087-.277-.227-.297-.348l-.179-1.072a1.875 1.875 0 0 0-1.85-1.567h-1.843ZM12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z","clip-rule":"evenodd"})])}const He={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function We(h,m){return c(),b("svg",He,m[0]||(m[0]=[_("path",{fill:"currentColor",d:"m17 3l5.25 4.5L17 12l5.25 4.5L17 21v-3h-2.74l-2.82-2.82l2.12-2.12L15.5 15H17V9h-1.5l-9 9H2v-3h3.26l9-9H17zM2 6h4.5l2.82 2.82l-2.12 2.12L5.26 9H2z"},null,-1)]))}const je={name:"mdi-shuffle-variant",render:We},Ze={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Ae(h,m){return c(),b("svg",Ze,m[0]||(m[0]=[_("path",{fill:"currentColor",d:"M12 2c5.53 0 10 4.47 10 10s-4.47 10-10 10S2 17.53 2 12S6.47 2 12 2m3.59 5L12 10.59L8.41 7L7 8.41L10.59 12L7 15.59L8.41 17L12 13.41L15.59 17L17 15.59L13.41 12L17 8.41z"},null,-1)]))}const Ye={name:"mdi-close-circle",render:Ae},Je={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Ke(h,m){return c(),b("svg",Je,m[0]||(m[0]=[_("path",{fill:"currentColor",d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10s10-4.5 10-10S17.5 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"},null,-1)]))}const Qe={name:"mdi-check-circle",render:Ke},Xe=()=>Ie({url:"/admin/permission/list",method:"get"});const eo={key:0},oo={key:1},lo={key:2},to={key:3},so={class:"flex justify-between"},ro={class:"flex space-x-2"},ao={class:"space-x-2"},no={class:"space-y-2"},io={class:"mb-5"},uo={class:"zfile-user-permission-checkbox-body"},X={__name:"index",setup(h){const m=_e();let ee=ve(),oe=ge(),D=ee.params.userId;const r=y({id:null,username:"",nickname:"",enable:!0,createTime:"",defaultPermissions:[],userStorageSourceList:[],roleId:""});be(()=>{T(),le()});const{init:T}=ie(),{loadPermissionList:le,permissionList:x,getPermissionName:te,showSetPermissionDialog:E,currentOpenPermissions:L,openSetPermissionDialog:q,enterSetPermissionDialog:se,setFromUserDefaultPermission:re}=de(),V=y(!1),O=y(null),ae=()=>{let g=r.value.userStorageSourceList.findIndex(e=>e.rootPath===void 0||e.rootPath===null||e.rootPath===""||!e.rootPath.startsWith("/"));if(g!==-1){A.error("第 ".concat(g+1," 个存储源的根目录配置错误，请检查。（不能为空，且必须以 / 开头）"));return}V.value=!0,O.value.validate(e=>{e?ze(r.value).then(u=>{A.success("保存成功");let n=u.data.id;n!=D?oe.push("/admin/user-edit/"+n):T()}).finally(()=>{V.value=!1}):V.value=!1})};let ne=y({username:[{required:!0,message:"请输入用户名"},{min:1,max:255,message:"长度应在 1 到 255 个字符",trigger:"blur"},{validator:(g,e,u)=>{if(e==null||e===""){u();return}let n={id:r.value.id,username:e};Ee(n).then(p=>{p.data?u(new Error("该用户名已存在，请修改。")):u()})}}],password:[{min:6,max:255,message:"长度在 6 到 255 个字符",trigger:"blur"}]});function ie(){const g=()=>{D?Ce(D).then(u=>{u.data.defaultPermissions||(u.data.defaultPermissions=[]),u.data.userStorageSourceList&&u.data.userStorageSourceList.forEach(n=>{n.permissions&&n.permissions.includes("available")&&n.permissions.splice(n.permissions.indexOf("available"),1)}),r.value=u.data,e()}):e()},e=()=>{Ue().then(u=>{let n=u.data,p=r.value.userStorageSourceList,w=n.map(v=>v.id),d=p.map(v=>v.storageSourceId),C=d.filter(v=>!w.includes(v)),U=w.filter(v=>!d.includes(v));C.forEach(v=>{let a=p.findIndex(S=>S.storageSourceId===v);console.log("检测到存储源被删除，删除掉：",p[a].storageSourceName),p.splice(a,1)}),U.forEach(v=>{let a=n.find(S=>S.id===v);p.push({storageSourceId:a.id,storageSourceName:a.name,rootPath:"/",enable:!1,permissions:[],new:!0}),console.log("检测到存储源被添加，添加进去：",a.name)})})};return{init:g}}const z=y(null),ue=W(()=>z.value?z.value.getSelectionRows().length:0);function de(){const g=y(!1),e=y([]),u=y({}),n=()=>{Xe().then(a=>{e.value=a.data,u.value=a.data.reduce((S,k)=>(S[k.value]=k,S),{})})},p=a=>{let S=u.value[a];return S?S.name:a},w=y([]),d=y(null);return{loadPermissionList:n,permissionList:e,getPermissionName:p,showSetPermissionDialog:g,openSetPermissionDialog:a=>{g.value=!0,d.value=a,w.value=a?a.permissions:[]},currentOpenPermissions:w,enterSetPermissionDialog:()=>{d.value?d.value.permissions=w.value:z.value.getSelectionRows().forEach(a=>{a.permissions=w.value}),g.value=!1},setFromUserDefaultPermission:()=>{w.value=r.value.defaultPermissions}}}const R=W({get:()=>r.value.userStorageSourceList.every(g=>g.enable),set:g=>{r.value.userStorageSourceList.forEach(e=>{e.enable=g})}});return(g,e)=>{const u=he,n=$e,p=Pe,w=Qe,d=Le,C=Ye,U=je,v=xe,a=De,S=Re,k=Be,F=Me,G=Te,B=qe,H=ke,me=Ne,pe=Ve,fe=ye,ce=Oe;return c(),b($,null,[o(r)?j((c(),I(pe,{key:0,model:o(r),"label-width":o(m).adminForm.labelWidth,"label-position":o(m).adminForm.labelPosition,size:o(m).adminForm.size,"scroll-to-error":"","status-icon":"",class:"z-admin-form",autocomplete:"nope",ref_key:"adminUserFormRef",ref:O,rules:o(ne)},{default:s(()=>[l(u,{title:"用户设置",to:"/admin/user-list"}),l(p,{size:o(m).adminForm.size,label:"用户名",prop:"username"},{default:s(()=>[l(n,{readonly:o(r).id===2,modelValue:o(r).username,"onUpdate:modelValue":e[0]||(e[0]=t=>o(r).username=t)},{suffix:s(()=>[o(r).id===0?(c(),b("span",eo,"内置虚拟新用户")):o(r).id===1?(c(),b("span",oo,"内置管理员用户")):o(r).id===2?(c(),b("span",lo,"内置匿名用户")):(c(),b("span",to,"普通用户"))]),_:1},8,["readonly","modelValue"])]),_:1},8,["size"]),l(p,{label:"用户昵称",prop:"nickname"},{default:s(()=>[l(n,{readonly:o(r).id===2,modelValue:o(r).nickname,"onUpdate:modelValue":e[1]||(e[1]=t=>o(r).nickname=t)},null,8,["readonly","modelValue"])]),_:1}),l(p,{label:"密码"},{default:s(()=>[l(n,{autocomplete:"off",modelValue:o(r).password,"onUpdate:modelValue":e[2]||(e[2]=t=>o(r).password=t),type:"password","show-password":""},null,8,["modelValue"]),e[16]||(e[16]=_("div",{class:"el-form-item-tips"}," 编辑时不显示密码，不修改密码请留空 ",-1))]),_:1,__:[16]}),l(p,{label:"用户默认权限"},{default:s(()=>[_("div",null,[l(v,{type:"primary",class:"mb-2"},{default:s(()=>[l(d,{onClick:e[3]||(e[3]=t=>o(r).defaultPermissions=o(x).map(i=>i.value))},{default:s(()=>[l(w,{class:"mr-1"}),e[17]||(e[17]=f(" 全选 "))]),_:1,__:[17]}),l(d,{onClick:e[4]||(e[4]=t=>o(r).defaultPermissions=[])},{default:s(()=>[l(C,{class:"mr-1"}),e[18]||(e[18]=f(" 全不选 "))]),_:1,__:[18]}),l(d,{onClick:e[5]||(e[5]=t=>o(r).defaultPermissions=o(x).filter(i=>!o(r).defaultPermissions.includes(i.value)).map(i=>i.value))},{default:s(()=>[l(U,{class:"mr-1"}),e[19]||(e[19]=f(" 反选 "))]),_:1,__:[19]})]),_:1}),l(S,{modelValue:o(r).defaultPermissions,"onUpdate:modelValue":e[6]||(e[6]=t=>o(r).defaultPermissions=t),class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5"},{default:s(()=>[(c(!0),b($,null,N(o(x),t=>(c(),I(a,{key:t.value,value:t.value},{default:s(()=>[f(P(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),e[20]||(e[20]=_("div",{class:"el-form-item-tips"}," 这里控制新增存储源时，该用户默认拥有的权限（仅对新增的存储源有效，已存在的但未授予权限的存储源不会使用此配置；如没有任何默认权限，则添加存储源时不会授予使用） ",-1))]),_:1,__:[20]}),l(p,{label:"存储源授权"},{default:s(()=>[l(v,null,{default:s(()=>[l(d,{type:"primary",size:"small",class:"mb-2",disabled:o(ue)===0,onClick:e[7]||(e[7]=t=>o(q)(null))},{default:s(()=>e[21]||(e[21]=[f("批量设置存储源列表 ")])),_:1,__:[21]},8,["disabled"])]),_:1}),l(me,{size:o(m).adminTable.size,data:o(r).userStorageSourceList,border:"",ref_key:"userStorageSourceTableRef",ref:z},{default:s(()=>[l(k,{type:"selection",width:"50"}),l(k,{"show-overflow-tooltip":"",prop:"storageSourceName",label:"存储源名称"},{default:s(t=>[_("div",so,[_("span",null,P(t.row.storageSourceName),1),t.row.new?(c(),I(G,{key:0,effect:"dark",content:"表示可能是新增的存储源，但该存储源还未授权.",placement:"left"},{default:s(()=>[l(F,{type:"success",size:"small"},{default:s(()=>e[22]||(e[22]=[f("new")])),_:1,__:[22]})]),_:1})):Z("",!0)])]),_:1}),l(k,{"show-overflow-tooltip":"",prop:"rootPath"},{header:s(()=>[e[24]||(e[24]=_("span",null,"授予根目录",-1)),l(B,{placement:"right",width:"300",trigger:"hover"},{default:s(()=>e[23]||(e[23]=[f(" 表示该用户使用存储源下哪个目录作为根目录，注意要先创建好目录，否则使用时可能会出现问题，且不能填写 URL 编码后的路径。 ")])),reference:s(()=>[l(o(K),{class:"inline w-4 ml-1 -mt-0.5"})]),_:1})]),default:s(t=>[l(n,{modelValue:t.row.rootPath,"onUpdate:modelValue":i=>t.row.rootPath=i,size:"small",placeholder:"请输入授权根目录"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(k,{width:"120px",prop:"enable",label:"允许使用"},{header:s(()=>[_("div",ro,[e[25]||(e[25]=_("span",null,"允许使用",-1)),l(G,{effect:"dark",content:"批量选择",placement:"top"},{default:s(()=>[l(a,{modelValue:o(R),"onUpdate:modelValue":e[8]||(e[8]=t=>M(R)?R.value=t:null),size:"small"},null,8,["modelValue"])]),_:1})])]),default:s(t=>[l(H,{modelValue:t.row.enable,"onUpdate:modelValue":i=>t.row.enable=i},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(k,{width:"120px",prop:"readOnly",label:"权限列表"},{default:s(t=>[_("div",ao,[l(B,{disabled:o(Y)(t.row.permissions)===0,placement:"left",width:10},{reference:s(()=>[l(F,{effect:"dark"},{default:s(()=>[f(P(o(Y)(t.row.permissions))+" 个",1)]),_:2},1024)]),default:s(()=>[_("div",no,[(c(!0),b($,null,N(t.row.permissions,i=>(c(),b("div",{class:"space-x-2",key:i.id},[l(F,null,{default:s(()=>[f(P(o(te)(i)),1)]),_:2},1024)]))),128))])]),_:2},1032,["disabled"]),l(o(Ge),{onClick:i=>o(q)(t.row),class:"inline w-5 text-blue-400 cursor-pointer"},null,8,["onClick"])])]),_:1})]),_:1},8,["size","data"])]),_:1}),l(p,{label:"启用状态"},{default:s(()=>[l(H,{modelValue:o(r).enable,"onUpdate:modelValue":e[9]||(e[9]=t=>o(r).enable=t)},null,8,["modelValue"])]),_:1}),l(p,{"label-width":o(m).adminForm.labelWidth,class:"admin-from-footer"},{default:s(()=>[l(d,{class:"ml-auto",type:"primary",icon:o(Q),loading:o(V),onClick:ae},{default:s(()=>e[26]||(e[26]=[f("保存")])),_:1,__:[26]},8,["icon","loading"])]),_:1},8,["label-width"])]),_:1},8,["model","label-width","label-position","size","rules"])),[[ce,o(V)]]):Z("",!0),l(fe,{"append-to-body":"",title:"设置权限列表",top:"5vh",width:o(we)?"95%":"400px",modelValue:o(E),"onUpdate:modelValue":e[15]||(e[15]=t=>M(E)?E.value=t:null)},{footer:s(()=>[l(d,{size:"default",onClick:e[14]||(e[14]=t=>E.value=!1)},{default:s(()=>e[31]||(e[31]=[f("取消")])),_:1,__:[31]}),l(d,{type:"primary",size:"default",icon:o(Q),onClick:o(se)},{default:s(()=>e[32]||(e[32]=[f("确认")])),_:1,__:[32]},8,["icon","onClick"])]),default:s(()=>[_("div",io,[l(d,{type:"primary",size:"small",onClick:e[10]||(e[10]=t=>L.value=o(x).map(i=>i.value))},{default:s(()=>e[27]||(e[27]=[f(" 全选 ")])),_:1,__:[27]}),l(d,{type:"primary",size:"small",onClick:e[11]||(e[11]=t=>L.value=[])},{default:s(()=>e[28]||(e[28]=[f("全不选")])),_:1,__:[28]}),l(d,{type:"primary",size:"small",onClick:e[12]||(e[12]=t=>L.value=o(x).filter(i=>!o(L).includes(i.value)).map(i=>i.value))},{default:s(()=>e[29]||(e[29]=[f(" 反选 ")])),_:1,__:[29]}),l(d,{type:"primary",size:"small",onClick:o(re)},{default:s(()=>e[30]||(e[30]=[f("设置为用户默认权限")])),_:1,__:[30]},8,["onClick"])]),_("div",uo,[l(S,{size:o(m).adminForm.size,modelValue:o(L),"onUpdate:modelValue":e[13]||(e[13]=t=>M(L)?L.value=t:null)},{default:s(()=>[(c(!0),b($,null,N(o(x),t=>(c(),I(a,{class:"!block",key:t.value,value:t.value},{default:s(()=>[_("span",null,P(t.name),1),l(B,{placement:"right",width:"300",trigger:"hover"},{default:s(()=>[f(P(t.tips),1)]),reference:s(()=>[j(l(o(K),{class:"inline w-4 ml-1 -mt-0.5"},null,512),[[Se,t.tips]])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["size","modelValue"])])]),_:1},8,["width","modelValue"])],64)}}};typeof J=="function"&&J(X);const ol=Fe(X,[["__scopeId","data-v-12c37dd8"]]);export{ol as default};
